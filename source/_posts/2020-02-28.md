---
title: 'Java线程池介绍'
catalog: true
date: 2020-02-28 14:51:56
subtitle:
header-img: "/img/header_img/ThreadPool.jpg"
categories:
- 线程池
tags:
- Java
---

### Java线程池介绍

程序执行的过程中，可以单独的开启一个线程来处理任务，开启一个线程很简单，但是如果开启的线程过多，线程执行的时间很短，系统频繁的创建和销毁线程，很耗费时间，浪费系统的资源。于是就需要把线程管理起来，形成一个线程池。有如下优点：

* 管理线程，避免增加创建线程和销毁线程的资源损耗。

* 提高线程复用，固定最大线程使用量，防止无限制地创建线程。

#### Java线程池创建

Java 提供了一套 Executor 框架，这个线程池框架中包含 ThreadPoolExecutor 和            ScheduledThreadPoolExecutor 两个核心线程池。ThreadPoolExecutor 用来执行被提交的任务，ScheduledThreadPoolExecutor 用来定时执行任务。用ThreadPoolExecutor创建线程代码如下：

```
public ThreadPoolExecutor(int corePoolSize, int maximumPoolSize,long keepAliveTime,TimeUnit unit,
   BlockingQueue<Runnable> workQueue,
   ThreadFactory threadFactory,
   RejectedExecutionHandler handler) 
```

* corePoolSize： 线程池核心线程数最大值

* maximumPoolSize： 线程池最大线程数大小

* keepAliveTime： 线程池中非核心线程空闲的存活时间大小

* unit： 线程空闲存活时间单位

* workQueue： 存放任务的阻塞队列

    1. ArrayBlockingQueue（有界队列）是一个用数组实现的有界阻塞队列，按FIFO排序量。
    2. LinkedBlockingQueue（可设置容量队列）基于链表结构的阻塞队列，按FIFO排序任务。
    3. DelayQueue（延迟队列）是一个任务定时周期的延迟执行的队列。
    4. PriorityBlockingQueue（优先级队列）是具有优先级的无界阻塞队列
    5. SynchronousQueue（同步队列）一个不存储元素的阻塞队列。


* threadFactory： 用于设置创建线程的工厂，可以给创建的线程设置有意义的名字，可方便排查问题。

* handler： 线城池的饱和策略事件，主要有四种类型。

    1. AbortPolicy(抛出一个异常，默认的)。
    2. DiscardPolicy(直接丢弃任务)。
    3. DiscardOldestPolicy(丢弃队列里最老的任务，将当前这个任务继续提交给线程池)。
    4. CallerRunsPolicy（交给线程池调用所在的线程进行处理)。

#### 线程池状态

线程池的5种状态：Running、ShutDown、Stop、Tidying、Terminated。

线程池各个状态切换框架图：

![20190621155050101](20190621155050101.jpg)


1. RUNNING：这是最正常的状态，接受新的任务，处理等待队列中的任务。线程池的初始化状态是RUNNING。线程池被一旦被创建，就处于RUNNING状态，并且线程池中的任务数为0。

2. SHUTDOWN：不接受新的任务提交，但是会继续处理等待队列中的任务。调用线程池的shutdown()方法时，线程池由RUNNING -> SHUTDOWN。

3. STOP：不接受新的任务提交，不再处理等待队列中的任务，中断正在执行任务的线程。调用线程池的shutdownNow()方法时，线程池由(RUNNING or SHUTDOWN ) -> STOP。

4. TIDYING：所有的任务都销毁了，workCount 为 0，线程池的状态在转换为 TIDYING 状态时，会执行钩子方法 terminated()。因为terminated()在ThreadPoolExecutor类中是空的，所以用户想在线程池变为TIDYING时进行相应的处理；可以通过重载terminated()函数来实现。当线程池在SHUTDOWN状态下，阻塞队列为空并且线程池中执行的任务也为空时，就会由 SHUTDOWN -> TIDYING。当线程池在STOP状态下，线程池中执行的任务为空时，就会由STOP -> TIDYING。

5. TERMINATED：线程池处在TIDYING状态时，执行完terminated()之后，就会由 TIDYING -> TERMINATED。
